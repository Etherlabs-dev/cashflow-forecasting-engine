{
  "nodes": [
    {
      "parameters": {},
      "id": "8352d850-5cf8-47fb-ac3f-88c0a21ef205",
      "name": "Daily Trigger",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [
        -240,
        224
      ]
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "bank_transactions"
      },
      "id": "f8b6c57d-65ab-4056-8b48-9cb5f59c04ba",
      "name": "Get Bank Transactions",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -16,
        224
      ],
      "credentials": {
        "supabaseApi": {
          "id": "BoyaYr6NqlfWTqWX",
          "name": "CashFlow Int - Etherlabs"
        }
      }
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "from collections import defaultdict\n\n# Get all input rows\nrows = [item['json'] for item in _input.all()]\n\n# Group transaction amounts by date\naggregated = defaultdict(lambda: {'cash_in': 0.0, 'cash_out': 0.0, 'net_cash': 0.0})\nfor row in rows:\n    date_str = row.get('transaction_date')  # e.g. '2025-01-01'\n    amount = float(row.get('amount', 0) or 0)\n    if amount >= 0:\n        aggregated[date_str]['cash_in'] += amount\n    else:\n        aggregated[date_str]['cash_out'] += -amount\n    aggregated[date_str]['net_cash'] += amount\n\n# Sort the dates\nsorted_dates = sorted(aggregated.keys())\n\n# Compute opening and closing balances cumulatively\nbalance = 0.0\ncompany_id = rows[0]['company_id'] if rows else None\nresults = []\nfor date_str in sorted_dates:\n    stats = aggregated[date_str]\n    opening_balance = balance\n    closing_balance = opening_balance + stats['net_cash']\n    results.append({\n        'company_id': company_id,\n        'date': date_str,\n        'opening_balance': opening_balance,\n        'cash_in': stats['cash_in'],\n        'cash_out': stats['cash_out'],\n        'net_cash': stats['net_cash'],\n        'closing_balance': closing_balance,\n        'metadata': {}\n    })\n    balance = closing_balance\n\n# Return one item per aggregated day\nreturn [{'json': r} for r in results]\n"
      },
      "id": "e8c41aad-8e87-4369-b1b2-961d4c293703",
      "name": "Aggregate Daily Flows",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        208,
        224
      ]
    },
    {
      "parameters": {
        "tableId": "daily_actuals"
      },
      "id": "d74e8978-5df4-480b-8ce9-8c3e5a9624a6",
      "name": "Delete Existing Daily Actuals",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        432,
        224
      ],
      "credentials": {
        "supabaseApi": {
          "id": "BoyaYr6NqlfWTqWX",
          "name": "CashFlow Int - Etherlabs"
        }
      }
    },
    {
      "parameters": {
        "tableId": "daily_actuals"
      },
      "id": "bff9dbc3-7b85-47fa-958e-d66c5dc08555",
      "name": "Insert Daily Actuals",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        656,
        224
      ],
      "credentials": {
        "supabaseApi": {
          "id": "BoyaYr6NqlfWTqWX",
          "name": "CashFlow Int - Etherlabs"
        }
      }
    }
  ],
  "connections": {
    "Daily Trigger": {
      "main": [
        [
          {
            "node": "Get Bank Transactions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Bank Transactions": {
      "main": [
        [
          {
            "node": "Aggregate Daily Flows",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Daily Flows": {
      "main": [
        [
          {
            "node": "Delete Existing Daily Actuals",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Existing Daily Actuals": {
      "main": [
        [
          {
            "node": "Insert Daily Actuals",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "5a3e3dff97b56398fc5a063b9d234339d0522fd99916021fa87b009517029ddd"
  }
}
